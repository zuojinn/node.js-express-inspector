function init_upload(q){var c=q.url,h=q.name,G=q.elm,e=q.size,u=q.pic,z=q.base_url,d=q.param,H=q.num,o=q.status,k=q.watch;if(!c||c==""){swal({title:"提示!",text:"url不能为空!",type:"info"});return false}if(!h||h==""){h="picture"}var r=h;if((!H||H=="")&&H!==0){H=1}if(!G||G==""){G="#uploader"}if(!z||z==""){z=""}if(!d||d==""){d={}}if(!u||u==""){u=[]}if(H!=1){h+="[]"}var I=$(G);I.append('<div class="queueList">'+'<div id="dndArea'+r+'" class="placeholder">'+'<div id="filePicker'+r+'"></div>'+"</div>"+"</div>"+'<div class="statusBar" style="display:none;">'+'<div class="uploader-progress">'+'<span class="text">0%</span>'+'<span class="percentage"></span>'+'</div><div class="info"></div>'+'<div class="btns">'+'<div id="filePicker2'+r+'" class="filePicker2"></div><div class="uploadBtn">开始上传</div>'+"</div>"+"</div>");var x=$('<ul class="filelist"></ul>').appendTo(I.find(".queueList")),i=I.find(".statusBar"),b=i.find(".info"),p=I.find(".uploadBtn"),l=I.find(".placeholder"),D=i.find(".uploader-progress").hide(),t=0,s=0,j=0,B=window.devicePixelRatio||1,v=110*B,n=110*B,J="pedding",f={},C=(function(){var L=new Image();var K=true;L.onload=L.onerror=function(){if(this.width!=1||this.height!=1){K=false}};L.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return K})(),g=(function(){var K;try{K=navigator.plugins["Shockwave Flash"];K=K.description}catch(L){try{K=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(M){K="0.0"}}K=K.match(/\d+/g);return parseFloat(K[0]+"."+K[1],10)})(),w=(function(){var K=document.createElement("p").style,L="transition" in K||"WebkitTransition" in K||"MozTransition" in K||"msTransition" in K||"OTransition" in K;K=null;return L})(),F;if(!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie){if(g){(function(K){window["expressinstallcallback"]=function(N){switch(N){case"Download.Cancelled":swal({title:"提示!",text:"您取消了更新！",type:"info"});break;case"Download.Failed":swal({title:"提示!",text:"安装失败!",type:"info"});break;default:swal({title:"提示!",text:"安装已成功，请刷新!",type:"info"});break}delete window["expressinstallcallback"]};var M="./expressInstall.swf";var L='<object type="application/'+'x-shockwave-flash" data="'+M+'" ';if(WebUploader.browser.ie){L+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}L+='width="100%" height="100%" style="outline:0">'+'<param name="movie" value="'+M+'" />'+'<param name="wmode" value="transparent" />'+'<param name="allowscriptaccess" value="always" />'+"</object>";K.html(L)})(I)}else{I.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')}return}else{if(!WebUploader.Uploader.support()){swal({title:"提示!",text:"Web Uploader 不支持您的浏览器!",type:"info"});return}}F=WebUploader.create({pick:{id:"#filePicker"+r,label:"点击选择图片"},formData:d,paste:G,swf:"../../dist/Uploader.swf",chunked:false,chunkSize:512*1024,server:c,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},compress:false,dnd:G,disableGlobalDnd:true,fileNumLimit:H,fileSizeLimit:200*1024*1024,fileSingleSizeLimit:e*1024});F.on("dndAccept",function(M){var L=false,K=M.length,N=0,O="text/plain;application/javascript ";for(;N<K;N++){if(~O.indexOf(M[N].type)){L=true;break}}return !L});F.addButton({id:"#filePicker2"+r,label:"继续添加"});F.on("ready",function(){window.uploader=F});function A(P){var Q=$('<li id="'+P.id+'">'+'<p class="title">'+P.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="uploader-progress"><span></span></p>'+'<input type="hidden" name="'+h+'"/>'+"</li>"),N=$('<div class="file-panel">'+'<span class="cancel" title="删除">删除</span>'+'<span class="move-first" title="移到首位">移到首位</span>'+"</div>").appendTo(Q),M=Q.find("p.uploader-progress span"),L=Q.find("p.imgWrap"),O=$('<p class="error"></p>'),K=function(R){switch(R){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败";break}O.text(text).appendTo(Q)};if(P.getStatus()==="invalid"){K(P.statusText)}else{L.text("预览中");F.makeThumb(P,function(S,T){var R;if(S){L.text("不能预览");return}if(C){R=$('<a href="#"><img src="'+T+'"></a>');L.empty().append(R)}else{L.text("预览出错")}},v,n);f[P.id]=[P.size,0];P.rotation=0}P.on("statuschange",function(S,R){if(R==="progress"){M.hide().width(0)}else{if(R==="queued"){}}if(S==="error"||S==="invalid"){K(P.statusText);f[P.id][1]=1}else{if(S==="interrupt"){K("interrupt")}else{if(S==="queued"){f[P.id][1]=0}else{if(S==="progress"){O.remove();M.css("display","block")}else{if(S==="complete"){Q.append('<span class="success"></span>')}}}}}Q.removeClass("state-"+R).addClass("state-"+S);if(k){watchData()}});Q.on("mouseenter",function(){N.stop().animate({height:30})});Q.on("mouseleave",function(){N.stop().animate({height:0})});N.on("click","span",function(){var R=$(this).index(),S;switch(R){case 0:F.removeFile(P);y();return;case 1:Q.prependTo(x);return}if(w){S="rotate("+P.rotation+"deg)";L.css({"-webkit-transform":S,"-mos-transform":S,"-o-transform":S,"transform":S})
}else{L.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((P.rotation/90)%4+4)%4)+")")}});Q.appendTo(x);if(k){watchData()}}function a(K){var L=$("#"+K.id);delete f[K.id];y();L.off().find(".file-panel").off().end().remove()}function y(){var K=0,N=0,L=D.children(),M;$.each(f,function(P,O){N+=O[0];K+=O[0]*O[1]});M=N?K/N:0;L.eq(0).text(Math.round(M*100)+"%");L.eq(1).css("width",Math.round(M*100)+"%");m()}function m(){var L="",K;if(J==="ready"){L="选中"+s+"张图片，共"+WebUploader.formatSize(j)+"。"}else{if(J==="confirm"){K=F.getStats();if(K.uploadFailNum){L="已成功上传"+K.successNum+"张图片，"+K.uploadFailNum+'张图片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{K=F.getStats();L="共"+s+"张（"+WebUploader.formatSize(j)+"），已上传"+K.successNum+"张";if(K.uploadFailNum){L+="，失败"+K.uploadFailNum+"张"}}}b.html(L)}function E(M){var L,K;if(M===J){return}p.removeClass("state-"+J);p.addClass("state-"+M);J=M;switch(J){case"pedding":if(t==0){l.removeClass("element-invisible");x.hide();i.addClass("element-invisible")}F.refresh();break;case"ready":l.addClass("element-invisible");if(H==0||s+t<H){$("#filePicker2"+r).removeClass("element-invisible")}x.show();i.removeClass("element-invisible");F.refresh();break;case"uploading":$("#filePicker2"+r).addClass("element-invisible");D.show();p.text("暂停上传");break;case"paused":D.show();p.text("继续上传");break;case"confirm":D.hide();if(H==0||s+t<H){$("#filePicker2"+r).removeClass("element-invisible")}p.text("开始上传");K=F.getStats();if(K.successNum&&!K.uploadFailNum){E("finish");return}break;case"finish":K=F.getStats();if(K.successNum){}else{J="done";location.reload()}break}m()}F.onUploadProgress=function(M,K){var N=$("#"+M.id),L=N.find(".uploader-progress span");L.css("width",K*100+"%");if(f[M.id]){f[M.id][1]=K}y()};F.onFileQueued=function(K){if(o==1){s=strCount.fileCount}s++;if(o==1){strCount.fileCount=s}if(H!=0&&!(s+t<H)){$("#filePicker2"+r).addClass("element-invisible")}j+=K.size;if(s===1){l.addClass("element-invisible");i.show()}A(K);E("ready");y()};F.onFileDequeued=function(K){if(o==1){s=strCount.fileCount}s--;j-=K.size;if(o==1){strCount.fileCount=s}if(!s){E("pedding")}if(H!=0&&s+t<H){$("#filePicker2"+r).removeClass("element-invisible")}a(K);y()};F.on("all",function(L){var K;switch(L){case"uploadFinished":E("confirm");break;case"startUpload":E("uploading");break;case"stopUpload":E("paused");break}});F.onError=function(L){var K={Q_TYPE_DENIED:"不支持该文件类型",Q_EXCEED_NUM_LIMIT:"上传图片数量过多",Q_EXCEED_SIZE_LIMIT:"上传图片过大",F_EXCEED_SIZE:"上传图片过大",F_DUPLICATE:"上传图片重复",};if(K[L]){L=K[L]}swal({title:"错误!",text:L,type:"info"})};p.on("click",function(){if($(this).hasClass("disabled")){return false}if(J==="ready"){F.upload()}else{if(J==="paused"){F.upload()}else{if(J==="uploading"){F.stop()}}}});F.onUploadSuccess=function(L,M){if(typeof M.path=="string"){$("#"+L.id).find("input[name='"+h+"']").val(M.path);I.find("a").attr("href",z+M.path).attr("target","_blank")}else{$("#"+L.id).find("input[name='"+h+"']").val(JSON.stringify(M.info));if(!z&&M.info.url){z=M.info.url+"/"}I.find("a").attr("href",z+M.info.path).attr("target","_blank")}if(M&&M.info=="sizeTooSmall"){var K=L.id;if(K){$("#"+K).find(".success").removeClass("success")}swal({title:"错误!",text:"上传图片尺寸太小(最小500*500),请删除!",type:"info"})}};b.on("click",".retry",function(){F.retry()});b.on("click",".ignore",function(){x.find(".state-error").each(function(){F.removeFile($(this).attr("id"))});m()});p.addClass("state-"+J);y();if(u.length>0){$.each(u,function(L,K){if(typeof K=="string"){$pic_li=$('<li class="state-complete">'+'<p class="title"></p>'+'<p class="imgWrap">'+'<a href="'+z+K+'" target="_blank"><img src="'+z+K+'" style="width:110px;height:110px"></a>'+"</p>"+'<p class="uploader-progress"><span></span></p>'+'<input type="hidden" name="'+h+'" value="'+K+'"/>'+'<div class="file-panel" style="height: 30px;">'+'<span class="cancel" title="删除">删除</span>'+'<span class="move-first" title="设为主图">设为主图</span>'+"</div>"+'<span class="success"></span>'+"</li>")}else{$pic_li=$('<li class="state-complete">'+'<p class="title"></p>'+'<p class="imgWrap">'+'<a href="'+K.url+"/"+K.path+'" target="_blank"><img src="'+K.url+"/"+K.path+'" style="width:110px;height:110px"></a>'+"</p>"+'<p class="uploader-progress"><span></span></p>'+'<input type="hidden" name="'+h+"\" value='"+JSON.stringify(K)+"'/>"+'<div class="file-panel" style="height: 30px;">'+'<span class="cancel" title="删除">删除</span>'+'<span class="move-first" title="设为主图">设为主图</span>'+"</div>"+'<span class="success"></span>'+"</li>")}$pic_li.find(".cancel").click(function(){$(this).parents("li").remove();t-=1;if(H!=0){F.option("fileNumLimit",F.option("fileNumLimit")+1)}$("#filePicker2"+r).removeClass("element-invisible");if(t==0&&s==0){l.removeClass("element-invisible");x.hide();i.addClass("element-invisible");F.refresh()}});$pic_li.find(".move-first").click(function(){$(this).parents("li").prependTo(x)});x.append($pic_li);t+=1});if(t>=H&&H!=0){$("#filePicker2"+r).addClass("element-invisible")
}if(H!=0){F.option("fileNumLimit",F.option("fileNumLimit")-t)}l.addClass("element-invisible");i.show()}strCount={picCount:t,fileCount:s,num:H,flag:r};return F};